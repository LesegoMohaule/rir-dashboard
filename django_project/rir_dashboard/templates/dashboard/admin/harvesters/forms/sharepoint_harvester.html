{% extends 'dashboard/admin/harvesters/forms/_base_attribute.html' %}
{% load static %}
{% block extrastyle %}
    <style>
        select {
            height: 42px;
        }

        .select2-container--default .select2-selection--multiple .select2-selection__choice {
            margin-top: 0 !important;
        }

        .rule-header {
            border-bottom: none !important;
        }

        #mapping-table .disabled .column-name {
            opacity: 0.4;
        }

        #mapping-table input[type="checkbox"] {
            cursor: pointer;
        }
    </style>
{% endblock %}
{% block extrascripts %}
    <link rel="stylesheet" href="{% static 'libs/select2/4.1.0-rc.0/select2.min.css' %}" type="text/css" media="screen, projection"/>
    <script type="text/javascript" src="{% static 'libs/select2/4.1.0-rc.0/select2.min.js' %}"></script>
    <script type="text/javascript" src="{% static 'libs/xlsx/0.17.5/jszip.js' %}"></script>
    <script type="text/javascript" src="{% static 'libs/xlsx/0.17.5/xlsx.js' %}"></script>
    <script>
        const isNew = "{{ indicator.harvester }}" ? false : true;
        let lastValue = {};
        let cookieName = 'sharepoint-harvester';
        if (getCookie(cookieName)) {
            try {
                lastValue = JSON.parse(getCookie(cookieName));
            } catch (e) {

            }
        }

        function getLastValueByFile(filename) {
            {# we get the latest cookie #}
            const cookieName = 'sharepoint-harvester-' + filename;
            if (getCookie(cookieName)) {
                try {
                    $.each(JSON.parse(getCookie(cookieName)), function (key, value) {
                        lastValue[key] = value
                    });
                } catch (e) {

                }
            }
        }

        function inputChanged(el) {
            lastValue[$(el).attr('id')] = $(el).val();
            setCookie(cookieName, JSON.stringify(lastValue))
            setCookie(cookieName + '-' + $('#attribute_file').val(), JSON.stringify(lastValue))
        }

        function inputDefaultValue($el) {
            if (lastValue[$el.attr('id')]) {
                $el.val(lastValue[$el.attr('id')]);
            }
        }

        function overrideSettings() {
            const cookieNameFile = cookieName + '-' + $('#attribute_file').val()
            const theValue = {};
            $('#attributes-table select, #attributes-table input').each(function () {
                lastValue[$(this).attr('id')] = $(this).attr('value');
            });
            lastValue['attribute_extra_columns'] = $('#attribute_extra_columns').attr('value').split(',');
            setCookie(cookieNameFile, JSON.stringify(theValue));
        }

        $(document).ready(function () {
            {# change the input to select input #}
            let $selectInput = $('#attributes-table input').not('#attribute_row_number_for_header');
            $selectInput.each(function () {
                const attr = [];
                $.each(this.attributes, function () {
                    attr.push(`${this.name}='${this.value}'`);
                });
                $(this).replaceWith(`<select ${attr.join(' ')}></select>`);
            });

            {# disabled inputs at first time#}
            const $inputRowHeader = $('#attribute_row_number_for_header');
            $inputRowHeader.prop('disabled', true);
            $inputRowHeader.attr('type', 'number');
            $inputRowHeader.val(1);

            $selectInput = $('#attributes-table select').not('#attribute_row_number_for_header');
            $selectInput.prop('disabled', true);
            $selectInput.change(function () {
                $(this).data('value', $(this).val())
            });

            {# create selection for the files #}
            const $inputFile = $('#attribute_file');
            {% if files %}
                $inputFile.prop('disabled', false);
                $inputFile.append('<option value=""></option>');
                {% for filename, path in files.items %}
                    $inputFile.append('<option value="{{ path }}">{{ filename }}</option>');
                {% endfor %}
            {% endif %}

            if (!isNew) {
                $inputFile.val($inputFile.attr('value'));
                overrideSettings()
            }
            /**
             * ---------------------------------------------------------
             * WHEN INPUT FILE CHANGED
             * ---------------------------------------------------------
             */
            const $inputSheetName = $('#attribute_sheet_name');
            const $inputExtraColumns = $('#attribute_extra_columns');
            $inputExtraColumns.attr('multiple', 'multiple');
            $inputFile.change(function () {
                getLastValueByFile($(this).val())
                $selectInput.not("#attribute_file").prop('disabled', true).html('').val('');
                $inputRowHeader.prop('disabled', true);

                {# fetch file and update others #}
                if ($(this).val()) {
                    $inputFile.closest('tr').find('.loading').show();
                    $inputFile.closest('tr').find('.hide').show();
                    var oReq = new XMLHttpRequest();
                    oReq.open('get', "{% url 'download-sharepoint' instance %}?file=" + $(this).val(), true);
                    oReq.responseType = 'blob';
                    oReq.onload = function () {
                        var blob = oReq.response;
                        var fr = new FileReader();
                        fr.onload = function () {
                            {#We check the output for construct the inputs #}
                            const workbook = XLSX.read(fr.result, {
                                type: 'binary'
                            });
                            $inputSheetName.prop('disabled', false);

                            $.each(workbook.Workbook.Sheets, function (index, sheet) {
                                if (sheet.Hidden === 0) {
                                    $inputSheetName.append(`<option value="${sheet.name}">${sheet.name}</option`);
                                }
                            });

                            {# when input row header changed #}
                            $inputRowHeader.change(function () {
                                inputChanged(this);
                                /** ---------------------------------------------------------
                                 *  Here we change the other options
                                 *  Based on sheet name and the header row number
                                 *  --------------------------------------------------------- */
                                var array = XLSX.utils.sheet_to_json(workbook.Sheets[$inputSheetName.val()], {
                                    header: 1,
                                    defval: '',
                                    blankrows: true
                                });
                                const $inputs = $selectInput.not("#attribute_file, #attribute_sheet_name");
                                $inputs.prop('disabled', false);
                                $inputs.html('');
                                $.each(array[$inputRowHeader.val() - 1], function (idx, value) {
                                    if (value) {
                                        $inputs.append(`<option value="${value}">${value}</option`);
                                    }
                                });
                                $inputs.each(function () {
                                    inputDefaultValue($(this));
                                });
                                $inputs.change(function () {
                                    inputChanged(this);
                                });
                                $('#attribute_extra_columns').select2();
                            });

                            {# when input sheet name changed #}
                            $inputSheetName.change(function () {
                                inputChanged(this);
                                $inputRowHeader.prop('disabled', false);
                                inputDefaultValue($inputRowHeader);
                                $inputRowHeader.trigger('change');
                            });
                            inputDefaultValue($inputSheetName);
                            $inputSheetName.trigger('change');
                        };
                        fr.readAsBinaryString(blob);
                        $inputFile.closest('tr').find('.error').hide();
                        $inputFile.closest('tr').find('.loading').hide();
                    };
                    oReq.addEventListener('error', function (xhr) {
                        $inputFile.closest('tr').find('.error').html(xhr.statusText);
                        $inputFile.closest('tr').find('.error').show();
                    });
                    oReq.send(null);
                }
            });
            $inputFile.trigger('change')
        });
    </script>
{% endblock extrascripts %}